<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>å¤§æ¨“åŒ…è£¹é€šçŸ¥ï¼ˆç®¡ç†ç«¯ï¼‰</title>
  <style>
    :root {
      --bg: #0b0f13;
      --card: #121822;
      --muted: #93a1b1;
      --text: #e8eef7;
      --accent: #4f8cff;
      --good: #24c08e;
      --warn: #ffb02e;
      --bad: #ff5c5c;
      --border: #202a36;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans",
        "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      max-width: 920px; margin: 32px auto; padding: 0 16px;
    }
    h1 { font-size: 22px; font-weight: 700; margin: 0 0 16px; }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      background: #0e141d; color: var(--text);
      border: 1px solid var(--border); outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .mt { margin-top: 16px; }
    .btnbar { display:flex; gap: 12px; align-items:center; }
    button {
      cursor: pointer; border: 0; padding: 12px 18px;
      border-radius: 12px; font-weight: 700;
      background: var(--accent); color: white;
    }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }
    .status {
      margin-top: 16px; padding: 12px 14px; border-radius: 12px;
      background: #0e141d; border: 1px solid var(--border); font-size: 14px;
      white-space: pre-wrap;
    }
    .ok { border-color: rgba(36,192,142,.6); }
    .partial { border-color: rgba(255,176,46,.6); }
    .bad { border-color: rgba(255,92,92,.6); }
    .badge { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .badge-ok { background: rgba(36,192,142,.15); color: var(--good); }
    .badge-partial { background: rgba(255,176,46,.15); color: var(--warn); }
    .badge-bad { background: rgba(255,92,92,.15); color: var(--bad); }
    .cap { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“¦ å¤§æ¨“åŒ…è£¹é€šçŸ¥ï¼ˆç®¡ç†ç«¯ï¼‰</h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="apt">é¸æ“‡é–€ç‰Œ</label>
          <select id="apt"></select>
          <div class="hint">è³‡æ–™ä¾†è‡ªè³‡æ–™åº«ï¼ˆseed.sql å·²å»ºç«‹ A/B æ£Ÿã€1â€“16 æ¨“ã€æ¯å±¤ 4 æˆ¶ï¼‰ã€‚</div>
        </div>
        <div>
          <label for="count">ä»¶æ•¸ï¼ˆå¯ç©ºç™½ï¼‰</label>
          <div class="btnbar">
            <input id="count" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š1">
            <button class="btn-ghost" data-q="1">+1</button>
            <button class="btn-ghost" data-q="2">+2</button>
            <button class="btn-ghost" data-q="3">+3</button>
            <button class="btn-ghost" data-q="0">æ¸…ç©º</button>
          </div>
        </div>
      </div>

      <div class="mt">
        <label for="note">å‚™è¨»ï¼ˆå¯ç©ºç™½ï¼‰</label>
        <textarea id="note" rows="3" placeholder="ä¾‹å¦‚ï¼šæ˜“ç¢ã€å†·å‡ã€æ›è™Ÿã€è«‹å…ˆåˆ°æ«ƒè‡ºç°½æ”¶â€¦"></textarea>
      </div>

      <div class="btnbar mt">
        <button id="send">é€å‡ºé€šçŸ¥</button>
        <button id="refresh" class="btn-ghost">é‡æ–°è¼‰å…¥é–€ç‰Œæ¸…å–®</button>
      </div>

      <div id="status" class="status" style="display:none"></div>
    </div>

    <p class="hint mt">
      æœ¬é é¢å·²ç”± Basic Auth ä¿è­·ã€‚å¸³å¯†ä¾†è‡ªä¼ºæœå™¨ç’°å¢ƒè®Šæ•¸
      <code>ADMIN_USER / ADMIN_PASS</code>ã€‚
    </p>
  </div>

  <script>
    const ddl = document.querySelector('#apt');
    const countEl = document.querySelector('#count');
    const noteEl = document.querySelector('#note');
    const statusEl = document.querySelector('#status');
    const btnSend = document.querySelector('#send');
    const btnRefresh = document.querySelector('#refresh');

    function showStatus(kind, msg) {
      statusEl.className = 'status ' + (kind || '');
      statusEl.style.display = 'block';
      statusEl.innerHTML = msg;
    }
    function clearStatus() {
      statusEl.style.display = 'none';
      statusEl.textContent = '';
      statusEl.className = 'status';
    }

    async function loadApts() {
      clearStatus();
      ddl.innerHTML = '<option value="">è¼‰å…¥ä¸­â€¦</option>';
      try {
        const res = await fetch('/api/apartments', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('è¼‰å…¥å¤±æ•—ï¼š' + res.status);
        const list = await res.json();
        ddl.innerHTML = '';
        // åŠ å€‹å¸¸ç”¨å¿«é€Ÿå‰ç¶´ A-14-1
        const pref = 'A-14-1';
        let hasPref = false;

        for (const r of list) {
          const opt = document.createElement('option');
          opt.value = r.apartment_no;
          opt.textContent = r.display_name || r.apartment_no;
          if (r.apartment_no === pref) hasPref = true;
          ddl.appendChild(opt);
        }
        if (hasPref) ddl.value = pref;
        showStatus('ok', 'âœ… é–€ç‰Œæ¸…å–®è¼‰å…¥å®Œæˆï¼Œå…± ' + list.length + ' æˆ¶ã€‚');
      } catch (err) {
        showStatus('bad', 'âŒ ç„¡æ³•è¼‰å…¥é–€ç‰Œæ¸…å–®ï¼š' + err.message);
      }
    }

    // é‡åŒ–å¿«æ·éµ
    document.querySelectorAll('[data-q]').forEach(btn => {
      btn.addEventListener('click', () => {
        const q = Number(btn.dataset.q);
        if (q === 0) { countEl.value = ''; return; }
        const cur = Number(countEl.value || 0);
        countEl.value = String(cur + q);
      });
    });

    btnRefresh.addEventListener('click', loadApts);

    btnSend.addEventListener('click', async () => {
      clearStatus();
      const apartment = ddl.value;
      const count = countEl.value ? Number(countEl.value) : undefined;
      const note = noteEl.value.trim() || undefined;

      if (!apartment) {
        showStatus('bad', 'âŒ è«‹å…ˆé¸æ“‡é–€ç‰Œã€‚');
        return;
      }

      btnSend.disabled = true;
      btnSend.textContent = 'é€å‡ºä¸­â€¦';

      try {
        const res = await fetch('/api/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ apartment, count, note })
        });

        const text = await res.text();
        let data = {};
        try { data = JSON.parse(text); } catch (_) {}

        if (res.status === 200) {
          const okCount = Array.isArray(data.results) ? data.results.filter(r => r.ok).length : 0;
          showStatus('ok',
            'âœ… å·²é€å‡ºé€šçŸ¥ï¼š<span class="badge badge-ok">OK</span> ' +
            '<span class="cap">' + okCount + '</span> ä½ã€‚' +
            (note ? '<br>å‚™è¨»ï¼š' + note : '')
          );
        } else if (res.status === 207) {
          // éƒ¨åˆ†æˆåŠŸ
          const ok = data.results?.filter(r => r.ok).length ?? 0;
          const fail = data.results?.length ? (data.results.length - ok) : 0;
          showStatus('partial',
            'âš ï¸ éƒ¨åˆ†æˆåŠŸï¼š<span class="badge badge-partial">PARTIAL</span> ' +
            'OK <span class="cap">' + ok + '</span> ä½ï¼›å¤±æ•— <span class="cap">' + fail + '</span> ä½ã€‚\n' +
            (data.results ? JSON.stringify(data.results, null, 2) : '')
          );
        } else {
          showStatus('bad',
            'âŒ é€å‡ºå¤±æ•—ï¼ˆHTTP ' + res.status + 'ï¼‰ã€‚\n' +
            (text || '')
          );
        }
      } catch (err) {
        showStatus('bad', 'âŒ é€å‡ºéŒ¯èª¤ï¼š' + err.message);
      } finally {
        btnSend.disabled = false;
        btnSend.textContent = 'é€å‡ºé€šçŸ¥';
      }
    });

    // åˆå§‹è¼‰å…¥
    loadApts();
  </script>
</body>
</html>
